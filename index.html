<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PINCOIN SAFE</title>
<style>
/* --- Visual: sobrio, azul --- */
:root { --blue: #00aaff; --muted: #9fd1ff; --bg:#000; --panel:#0b0b10; }
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:Inter, Arial, sans-serif;}
.header{display:flex;align-items:center;justify-content:center;padding:18px 12px}
.logo{font-weight:700;font-size:28px;color:var(--blue);letter-spacing:2px}
.wrapper{max-width:980px;margin:12px auto;padding:18px;background:rgba(11,11,16,0.85);border-radius:10px;border:1px solid rgba(0,170,255,0.12);box-shadow:0 6px 30px rgba(0,0,0,0.6);}
.top-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}
.vault{flex:1;min-width:240px;text-align:center;padding:18px;border-radius:8px;border:1px solid rgba(0,170,255,0.08);background:linear-gradient(0deg, rgba(255,255,255,0.01), transparent)}
#prize{font-size:40px;color:var(--blue);font-weight:700}
.counter{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,170,255,0.15);background:#06061a;color:var(--muted);font-weight:600}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px;justify-content:center}
input[type="text"],button,select{padding:10px;border-radius:8px;border:2px solid rgba(0,170,255,0.14);background:#000;color:var(--muted);font-size:15px}
button{cursor:pointer}
.btn-blue{background:transparent;border:2px solid var(--blue);color:var(--blue);font-weight:700}
.small{font-size:13px;color:#9fbfdf}

/* chats */
.col{margin-top:18px}
.chat, .chat-global{max-height:240px;overflow:auto;padding:12px;border-radius:8px;border:1px solid rgba(0,170,255,0.08);background:#070714}
.msg{margin-bottom:8px}
.meta{font-size:12px;color:#83c7ff;margin-bottom:4px}

/* modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:9999}
.modal-card{width: min(720px,94%);background:#04040a;border:2px solid var(--blue);padding:18px;border-radius:10px;color:var(--muted)}
.lang-row{display:flex;gap:8px;justify-content:center;margin-top:12px}
@media(max-width:800px){
  #prize{font-size:28px}
  .controls{flex-direction:column}
}
.link{color:var(--blue);text-decoration:none}
.lema{margin-top:6px;font-size:16px;color:#cfeeff;font-style:italic}
</style>
</head>
<body>

<div class="header"><div class="logo">PINCOIN</div></div>

<div class="wrapper" id="app" aria-live="polite">

  <!-- Top: vault + counter -->
  <div class="top-row">
    <div class="vault">
      <div id="prize">10,000,000 $PIN</div>
      <div class="lema">One PIN away from the impossible.</div>
      <div style="margin-top:8px;font-size:13px">
        <a id="tokenLink" class="link" href="#" target="_blank" rel="noopener">View token</a>
      </div>
    </div>

    <div style="min-width:220px;display:flex;flex-direction:column;gap:10px;align-items:center">
      <div id="attemptsCounter" class="counter">Total attempts: 0</div>
      <div id="walletBlock" class="small">Wallet: not connected</div>
      <button id="connectBtn" class="btn-blue" onclick="connectPhantom()">Connect Phantom</button>
    </div>
  </div>

  <!-- Controls: PIN input -->
  <div class="controls" style="justify-content:center">
    <input id="pinInput" type="text" placeholder="Enter PIN" aria-label="Enter PIN">
    <button id="tryBtn" class="btn-blue" onclick="tryPin()">Try</button>
    <label class="small" style="display:flex;align-items:center;gap:8px"><input id="anonCheckbox" type="checkbox"> Participate anonymously</label>
  </div>

  <!-- two columns: attempts chat + global chat -->
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:14px">
    <div style="flex:1;min-width:280px" class="col">
      <div style="font-weight:700;color:var(--blue);margin-bottom:6px" id="attemptsTitle">Attempts</div>
      <div id="attemptsChat" class="chat" aria-live="polite"></div>
    </div>

    <div style="flex:1;min-width:280px" class="col">
      <div style="font-weight:700;color:var(--blue);margin-bottom:6px" id="globalTitle">Global Chat</div>
      <div id="globalChat" class="chat-global" aria-live="polite"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="globalInput" placeholder="Pincoin: Username: message" class="small" style="flex:1;padding:10px;border-radius:8px;background:#000;color:var(--muted);border:1px solid rgba(0,170,255,0.07)">
        <button class="btn-blue" onclick="sendGlobal()">Send</button>
      </div>
    </div>
  </div>

  <div style="margin-top:18px;font-size:13px;color:#9fbfdf">
    <strong>About Pincoin:</strong> Pincoin is a memecoin with utility. Connect your Phantom wallet to participate in challenges and giveaways.
  </div>

</div>

<!-- --- MODALS: Language -> Privacy -> (wallet prompt) --- -->

<!-- Language modal (forced first) -->
<div id="languageModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h2 style="color:var(--blue);text-align:center">Select language / Selecciona idioma</h2>
    <div class="lang-row" style="margin-top:14px">
      <button class="btn-blue" onclick="setLanguage('en')">English</button>
      <button class="btn-blue" onclick="setLanguage('es')">Español</button>
    </div>
  </div>
</div>

<!-- Privacy modal -->
<div id="privacyModal" class="modal" style="display:none" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h3 id="policyTitle" style="color:var(--blue)"></h3>
    <div id="policyText" style="white-space:pre-wrap;margin-top:10px"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="acceptPolicyBtn" class="btn-blue" onclick="acceptPolicy()">Accept</button>
    </div>
  </div>
</div>

<script>
/* ==========================
   Configuration & constants
   ========================== */
const SOLANA_RPC = 'https://api.mainnet-beta.solana.com'; // change if you have custom RPC
const TOKEN_MINT = 'Jz1Jy2oxiNeyCF5TLPX4RMoAiCVpczpk1rFFzS1pump'; // Pincoin mint provided
const NETLIFY_COUNTER_ENDPOINT = '/.netlify/functions/counter'; // optional
const BOT_INTERVAL_MS = 5000;

/* --------------------------
   Internationalized texts
   -------------------------- */
let lang = 'en'; // default until user selects
const TEXTS = {
  en: {
    policyTitle: 'Privacy Policy & Terms',
    policy: `This website is for entertainment and utility only and is linked to the Pincoin memecoin.
Participation is voluntary and free. You may participate if you hold at least 1 PIN in a connected Phantom wallet.
The site connects only to verify token ownership; no personal data or private keys are stored.
All attempts and actions are temporary and may be deleted.
The community and website administrators may adjust prizes, probabilities and any parameter at any time.
Only the connected wallet at the time of a win will be used for payout. Payouts are processed manually.
This is not financial advice.`,
    acceptBtn: 'Accept',
    connectBtn: 'Connect Phantom',
    connectRequired: 'Connect Phantom to verify balance (≥1 PIN).',
    attemptsTitle: 'Attempts',
    globalTitle: 'Global Chat',
    walletNotConnected: 'Wallet: not connected',
    walletConnected: 'Wallet: connected'
  },
  es: {
    policyTitle: 'Política de Privacidad y Términos',
    policy: `Esta web es únicamente con fines de entretenimiento y utilidad y está vinculada al memecoin Pincoin.
La participación es voluntaria y gratuita. Puedes participar si tienes al menos 1 PIN en una Phantom wallet conectada.
La web solo se conecta para verificar la propiedad del token; no se almacenan datos personales ni claves privadas.
Todos los intentos y acciones son temporales y pueden eliminarse.
La comunidad y los administradores pueden ajustar premios, probabilidades y cualquier parámetro en cualquier momento.
Solo la wallet conectada en el momento de la ganancia se usará para el pago. Los pagos son manuales.
Esto no es asesoramiento financiero.`,
    acceptBtn: 'Aceptar',
    connectBtn: 'Conectar Phantom',
    connectRequired: 'Conecta Phantom para verificar saldo (≥1 PIN).',
    attemptsTitle: 'Intentos',
    globalTitle: 'Chat Global',
    walletNotConnected: 'Wallet: no conectada',
    walletConnected: 'Wallet: conectada'
  }
};

/* ==========================
   DOM bindings
   ========================== */
const languageModal = document.getElementById('languageModal');
const privacyModal  = document.getElementById('privacyModal');
const policyTitleEl = document.getElementById('policyTitle');
const policyTextEl  = document.getElementById('policyText');
const acceptPolicyBtn = document.getElementById('acceptPolicyBtn');
const connectBtn = document.getElementById('connectBtn');
const walletBlock = document.getElementById('walletBlock');
const attemptsCounterEl = document.getElementById('attemptsCounter');
const attemptsChat = document.getElementById('attemptsChat');
const globalChat = document.getElementById('globalChat');
const globalInput = document.getElementById('globalInput');
const tokenLink = document.getElementById('tokenLink');

tokenLink.href = `https://explorer.solana.com/address/${TOKEN_MINT}?cluster=mainnet-beta`;
tokenLink.textContent = 'View token on Solana Explorer';

/* ==========================
   Counter: hybrid (remote fallback local)
   ========================== */
const COUNTER_KEY = 'pincoin_attempts_total_local';

function formatNumber(n){ return n.toLocaleString(); }

async function fetchRemoteTotal(){
  try{
    const res = await fetch(NETLIFY_COUNTER_ENDPOINT, {method:'GET'});
    if(!res.ok) throw new Error('no remote');
    const j = await res.json();
    return Number(j.total);
  }catch(e){ return null; }
}

async function incrementRemoteTotal(){
  try{
    const res = await fetch(NETLIFY_COUNTER_ENDPOINT, {method:'POST'});
    if(!res.ok) throw new Error('no remote increment');
    const j = await res.json();
    return Number(j.total);
  }catch(e){ return null; }
}

function getLocalTotal(){ return Number(localStorage.getItem(COUNTER_KEY) || 0); }
function setLocalTotal(n){ localStorage.setItem(COUNTER_KEY,String(n)); }
function updateCounterDisplayWith(n){
  attemptsCounterEl.textContent = (lang==='es'?'Intentos totales: ':'Total attempts: ') + formatNumber(n);
}
async function updateCounterDisplay(){
  const remote = await fetchRemoteTotal();
  const total = (remote !== null) ? remote : getLocalTotal();
  updateCounterDisplayWith(total);
}
async function incrementTotalHybrid(){
  const remote = await incrementRemoteTotal();
  if(remote !== null){
    setLocalTotal(remote);
    updateCounterDisplayWith(remote);
    return;
  }
  const local = getLocalTotal()+1;
  setLocalTotal(local);
  updateCounterDisplayWith(local);
}

/* ==========================
   Language and policy flow
   ========================== */
function setLanguage(selected){
  lang = selected;
  languageModal.style.display = 'none';
  // populate policy texts
  policyTitleEl.textContent = TEXTS[lang].policyTitle;
  policyTextEl.textContent = TEXTS[lang].policy;
  acceptPolicyBtn.textContent = TEXTS[lang].acceptBtn;
  // open privacy modal
  privacyModal.style.display = 'flex';
  document.getElementById('attemptsTitle').textContent = TEXTS[lang].attemptsTitle;
  document.getElementById('globalTitle').textContent = TEXTS[lang].globalTitle;
  connectBtn.textContent = TEXTS[lang].connectBtn;
  updateCounterDisplay();
}

function acceptPolicy(){
  privacyModal.style.display = 'none';
  // show connect UI (connect button already visible)
  // we require user to click connect to access functions
  // walletBlock indicates status
  walletBlock.textContent = (lang==='es'?TEXTS[lang].walletNotConnected:TEXTS[lang].walletNotConnected);
}

/* ==========================
   Phantom integration + token check
   ========================== */
let provider = null;
let connectedPubkey = null;

function getProvider(){
  if('solana' in window) {
    const p = window.solana;
    if(p.isPhantom) return p;
  }
  return null;
}

async function connectPhantom(){
  provider = getProvider();
  if(!provider){
    alert(lang==='es' ? 'Instala Phantom wallet para continuar' : 'Install Phantom wallet to continue');
    return;
  }
  try{
    const resp = await provider.connect();
    connectedPubkey = resp.publicKey.toString();
    walletBlock.textContent = (lang==='es' ? 'Wallet: ' : 'Wallet: ') + truncateWallet(connectedPubkey);
    // check token balance
    connectBtn.disabled = true;
    connectBtn.textContent = 'Checking...';
    const has = await checkHasTokenAtLeastOne(connectedPubkey, TOKEN_MINT);
    connectBtn.disabled = false;
    connectBtn.textContent = TEXTS[lang].connectBtn;
    if(has){
      walletBlock.textContent = (lang==='es' ? 'Wallet: ' : 'Wallet: ') + truncateWallet(connectedPubkey);
      // unlock main UI (controls already visible)
      // nothing else required: user can try pins
    } else {
      walletBlock.textContent = (lang==='es' ? 'Wallet: no cumple (>=1 PIN requerido)' : 'Wallet: does not meet requirement (>=1 PIN required)');
      alert(lang==='es' ? 'Se requiere al menos 1 PIN en la wallet para participar' : 'At least 1 PIN is required in the wallet to participate');
      // keep connectedPubkey but block tries: tryPin checks balance before incrementing
    }
  }catch(err){
    console.error(err);
    alert(lang==='es' ? 'Conexión cancelada o fallida' : 'Connection cancelled or failed');
  }
}

function truncateWallet(pk){
  if(!pk) return '';
  return pk.slice(0,4) + '…' + pk.slice(-4);
}

/* Use Solana RPC to check token accounts by owner filtered by mint (jsonParsed) */
async function checkHasTokenAtLeastOne(ownerPubkey, mintAddress){
  try{
    const body = {
      jsonrpc: "2.0",
      id: 1,
      method: "getTokenAccountsByOwner",
      params: [
        ownerPubkey,
        { mint: mintAddress },
        { encoding: "jsonParsed" }
      ]
    };
    const r = await fetch(SOLANA_RPC, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error('RPC fail');
    const j = await r.json();
    if(!j.result || !Array.isArray(j.result.value)) return false;
    const accounts = j.result.value;
    if(accounts.length === 0) return false;
    // sum amounts (tokenAmount.uiAmount may be null if big int; handle tokenAmount.amount and decimals)
    for(const acc of accounts){
      try{
        const tokenAmount = acc.account.data.parsed.info.tokenAmount;
        const uiAmount = tokenAmount.uiAmount;
        const amountStr = tokenAmount.amount;
        const decimals = tokenAmount.decimals || 0;
        const numeric = (typeof uiAmount === 'number') ? uiAmount : (Number(amountStr) / Math.pow(10,decimals));
        if(numeric >= 1) return true;
      }catch(e){ continue; }
    }
    return false;
  }catch(e){
    console.warn('Token check failed', e);
    // fallback: do not block due to transient RPC failure; treat as false
    return false;
  }
}

/* ==========================
   Attempts & Chats
   ========================== */
function appendAttempt(userLabel, text, success=false){
  const d = document.createElement('div');
  d.className = 'msg';
  const meta = document.createElement('div'); meta.className='meta';
  meta.textContent = `${userLabel} · ${new Date().toLocaleTimeString()}`;
  const body = document.createElement('div');
  body.textContent = text + (success ? ' → success' : ' → fail');
  d.appendChild(meta); d.appendChild(body);
  attemptsChat.prepend(d);
  // keep attemptsChat scroll reasonable
  while(attemptsChat.children.length > 200) attemptsChat.removeChild(attemptsChat.lastChild);
}

/* user try */
async function tryPin(){
  if(!connectedPubkey){
    alert(lang==='es' ? 'Conecta tu wallet para participar' : 'Connect your wallet to participate');
    return;
  }
  // re-check has token to ensure still holds >=1
  const has = await checkHasTokenAtLeastOne(connectedPubkey, TOKEN_MINT);
  if(!has){
    alert(lang==='es' ? 'No tienes al menos 1 PIN en la wallet' : 'You do not have at least 1 PIN in the wallet');
    return;
  }
  const pin = document.getElementById('pinInput').value.trim();
  if(pin === '') return;
  const anon = document.getElementById('anonCheckbox').checked;
  const userLabel = anon ? 'Anonimus' : truncateWallet(connectedPubkey);
  appendAttempt(userLabel, `Tries: ${pin}`, false);
  await incrementTotalHybrid();
  document.getElementById('pinInput').value = '';
}

/* global chat send */
function sendGlobal(){
  const text = (document.getElementById('globalInput').value || '').trim();
  if(!text) return;
  const node = document.createElement('div'); node.className='msg';
  node.textContent = text;
  globalChat.prepend(node);
  while(globalChat.children.length > 20) globalChat.removeChild(globalChat.lastChild);
  document.getElementById('globalInput').value = '';
}

/* ==========================
   Bot attempts (mix with users)
   ========================== */
function botTry(){
  // only show bots after user connected + policy accepted (privacyModal hidden)
  if(!connectedPubkey && privacyModal.style.display === 'none') return;
  const fakePin = String(Math.floor(Math.random() * 100000)).padStart(5,'0');
  appendAttempt('Anonimus', `Tries: ${fakePin}`, false);
  incrementTotalHybrid();
}
setInterval(botTry, BOT_INTERVAL_MS);

/* ==========================
   Init: update UI language placeholders
   ========================== */
function initPlaceholders(){
  // nothing until user picks language (language modal forced)
  updateCounterDisplay();
}
initPlaceholders();

</script>
</body>
</html>
