<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PINCOIN SAFE</title>
<style>
:root{--blue:#00bfff;--bg:#001f3f;--muted:#cfeeff;--gold:#d4af37}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:Inter, Arial, sans-serif}
.header{display:flex;align-items:center;justify-content:center;padding:18px 12px}
.logo{font-weight:800;font-size:28px;color:var(--gold);letter-spacing:2px}
.wrapper{max-width:980px;margin:14px auto;padding:18px;background:rgba(0,0,0,0.85);border-radius:10px;border:1px solid rgba(0,191,255,0.06)}
.top{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-start;justify-content:space-between}
.vault{flex:1;min-width:300px;padding:18px;border-radius:8px;border:1px solid rgba(0,191,255,0.06);text-align:center;background:linear-gradient(0deg, rgba(255,255,255,0.01), transparent)}
#prize{font-size:34px;color:var(--blue);font-weight:800}
.lead{color:#cfeeff;margin-top:6px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:12px}
input[type="text"],button,select{padding:10px;border-radius:8px;border:2px solid rgba(0,191,255,0.14);background:transparent;color:var(--muted);font-size:15px}
.btn-primary{background:transparent;border:2px solid var(--blue);color:var(--blue);font-weight:700;padding:10px 14px;border-radius:8px}
.small{font-size:13px;color:#9fbfdf}
.col{margin-top:18px}
.chat, .global-chat{max-height:260px;overflow:auto;padding:12px;border-radius:8px;border:1px solid rgba(0,191,255,0.06);background:#041022}
.msg{margin-bottom:8px}
.meta{font-size:12px;color:#83c7ff;margin-bottom:4px}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:9999}
.modal-card{width:min(880px,96%);background:#041022;border:2px solid var(--blue);padding:18px;border-radius:10px;color:var(--muted)}
.lang-row{display:flex;gap:8px;justify-content:center;margin-top:12px}
#privacyText{max-height:420px;overflow:auto;padding:8px;border:1px solid rgba(0,191,255,0.06);border-radius:8px;background:#001627}
.badge{margin:15px 0;padding:10px;border:2px solid var(--blue);border-radius:8px;font-weight:700}
.kv{font-weight:700;color:var(--blue)}
.footer-note{font-size:12px;color:#9fbfdf;margin-top:12px;text-align:center}
@media(max-width:900px){#prize{font-size:28px}.top{flex-direction:column;align-items:center}}
</style>
</head>
<body>
<div class="header"><div class="logo">PINCOIN</div></div>

<div class="wrapper" id="app" style="display:block">

  <div class="top" aria-label="Main">
    <div class="vault" role="region" aria-label="Vault">
      <div id="prize">10,000,000 $PIN</div>
      <div class="lead" id="slogan">¿Podrás abrir la caja fuerte y hacerte millonario?</div>
      <div style="margin-top:10px"><a id="tokenLink" href="https://solscan.io/token/Jz1Jy2oxiNeyCF5TLPX4RMoAiCVpczpk1rFFzS1pump" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none">Ver token en Solana Explorer</a></div>
      <div class="badge" id="probBadge">Precio actual: -- | Probabilidad: muy baja</div>
    </div>

    <div style="min-width:260px;display:flex;flex-direction:column;gap:10px;align-items:center">
      <div id="attemptsCounter" class="badge" aria-live="polite">Intentos totales: 0</div>
      <div id="walletInfo" class="small">Wallet: no verificada</div>
      <button id="verifyBtn" class="btn-primary" onclick="openVerify()">Verificar titularidad</button>
    </div>
  </div>

  <div class="controls" role="region" aria-label="Controles principales">
    <input id="pinInput" type="text" placeholder="Introduce PIN">
    <button id="tryBtn" class="btn-primary" onclick="tryPin()">Intentar</button>
    <label class="small" style="display:flex;align-items:center;gap:8px"><input id="anonCheckbox" type="checkbox"> Participar anónimamente</label>
  </div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:14px">
    <div style="flex:1;min-width:300px" class="col" aria-label="Chat de intentos">
      <div style="font-weight:800;color:var(--blue);margin-bottom:6px">Intentos</div>
      <div id="attemptsChat" class="chat" aria-live="polite"></div>
    </div>

    <div style="flex:1;min-width:300px" class="col" aria-label="Chat global">
      <div style="font-weight:800;color:var(--blue);margin-bottom:6px">Chat Global</div>
      <div id="globalChat" class="global-chat" aria-live="polite"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="globalInput" placeholder="Pincoin:TuNick: mensaje" class="chat-input" aria-label="Input chat global" />
        <button class="btn-primary" onclick="sendGlobal()">Enviar</button>
      </div>
    </div>
  </div>

  <div style="margin-top:18px;font-size:13px;color:#9fbfdf">
    <strong>Sobre Pincoin:</strong> <span id="aboutText">Pincoin es una memecoin con utilidad. Verifica tu wallet para participar en sorteos.</span>
    <div style="margin-top:8px" class="lead">No existe PIN fijo; cada intento se decide por probabilidad.</div>
  </div>

  <div class="footer-note">No es inversión. Todo lo mostrado es orientativo.</div>
</div>

<!-- LANGUAGE modal (obligatorio) -->
<div id="languageModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h2 style="color:var(--blue);text-align:center">Selecciona idioma</h2>
    <div class="lang-row" style="margin-top:14px">
      <button class="btn-primary" data-lang="es">Español</button>
      <button class="btn-primary" data-lang="en">English</button>
    </div>
  </div>
</div>

<!-- PRIVACY modal (obligatorio) -->
<div id="privacyModal" class="modal" style="display:none" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h3 id="policyTitle" style="color:var(--blue)">Política de Privacidad y Términos</h3>
    <div id="privacyText" style="white-space:pre-wrap;margin-top:10px"></div>
    <div style="text-align:center;margin-top:12px">
      <button id="acceptPolicyBtn" class="btn-primary accept" disabled>Aceptar</button>
    </div>
  </div>
</div>

<!-- VERIFY WALLET modal -->
<div id="verifyModal" class="modal" style="display:none">
  <div class="modal-card">
    <h3 style="color:var(--blue)">Verificar titularidad</h3>
    <p>Introduce tu dirección de wallet (Solana). Comprobamos si tienes 1 o más PIN.</p>
    <input id="verifyWalletInput" placeholder="Escribe tu wallet" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,191,255,0.08);background:#00162a;color:var(--muted)">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="btn-primary" onclick="doVerifyWallet()">Verificar titularidad</button>
      <a class="btn-primary" href="https://solscan.io/token/Jz1Jy2oxiNeyCF5TLPX4RMoAiCVpczpk1rFFzS1pump" target="_blank" rel="noopener">Ver token (Solscan)</a>
    </div>
    <div id="verifyResult" style="margin-top:8px;color:#bfe"></div>
  </div>
</div>

<!-- WINNER modal -->
<div id="winnerModal" class="modal" style="display:none"><div class="modal-card"><h2 style="color:var(--blue)">¡Ganador!</h2><div id="winnerText"></div><div style="text-align:center;margin-top:12px"><button class="btn-primary" onclick="closeWinner()">Cerrar</button></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
/* =========================
   CONFIG
   ========================= */
const SUPABASE_URL = "https://ijsxpqbqasegolfpdtkl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqc3hwcWJxYXNlZ29sZnBkdGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTE2ODUsImV4cCI6MjA3NTc2NzY4NX0.gTTyAs_1g8qtF3Tu1dok3lg631bAZKWVMiLm3WT1xH4";
const TOKEN_MINT = "Jz1Jy2oxiNeyCF5TLPX4RMoAiCVpczpk1rFFzS1pump";
const SOLANA_RPC = "https://api.mainnet-beta.solana.com"; // RPC public
const P_MAX = 0.20; // 20% at $1.0

/* =========================
   STATE + CLIENTS
   ========================= */
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let lang = 'es';
let verifiedWallet = null; // wallet completa si verificada
let attemptsLocal = 0;
let currentPrice = 0;
let currentProb = 0;

/* =========================
   TEXTS (i18n)
   ========================= */
const TEXTS = {
  es: {
    policyTitle: 'Política de Privacidad y Términos',
    policy: `Pincoin - Política de Privacidad y Términos

Pincoin es una plataforma experimental y de entretenimiento vinculada al memecoin Pincoin.

1) Uso de la wallet:
La conexión a la wallet (introducida manualmente) se utiliza exclusivamente para verificar la posesión del token Pincoin en la wallet indicada (solo lectura). No se solicitan ni almacenan frases semilla ni claves privadas. La wallet completa se guardará solo en caso de que el usuario resulte ganador y se necesite comprobar la entrega del premio.

2) Registro y datos:
No se almacenan los intentos fallidos ni mensajes privados de usuarios. El chat global almacenará hasta los últimos 20 mensajes. Solo se guarda la información del ganador (wallet completa, pin acertado, fecha/hora) para permitir la entrega manual del premio.

3) Premios y bote:
El bote inicial es de 10,000,000 PIN. El premio máximo disponible por evento es el 25% del bote. La cantidad exacta será decidida por la comunidad o los administradores y anunciada públicamente en las redes oficiales.

4) Probabilidades:
La probabilidad de acierto se ajusta periódicamente según el precio real de Pincoin. A medida que el precio aumenta, la probabilidad aumenta hasta un máximo del 20% cuando el precio alcance $1 USD. Esto es una dinámica del sitio y puede cambiar.

5) Aceptación:
Al aceptar esta política el usuario declara haberla leído, entendido y otorga permiso expreso a la plataforma para realizar las comprobaciones descritas (verificación de token, registro de ganadores). La participación es voluntaria y no constituye asesoramiento financiero.

6) Responsabilidad:
Pincoin no se hace responsable de pérdidas, daños o malentendidos derivados del uso de la plataforma. Participa con precaución y solo con fondos que puedas permitirte arriesgar.

Sigue las redes oficiales para noticias, cambios y decisiones de la comunidad.`,
    acceptBtn: 'Aceptar',
    verifyBtn: 'Verificar titularidad',
    walletMissing: 'Introduce una wallet válida.',
    needToken: 'Necesitas al menos 1 PIN para participar.'
  },
  en: {
    policyTitle: 'Privacy Policy & Terms',
    policy: `Pincoin - Privacy Policy & Terms

Pincoin is an experimental entertainment platform linked to the Pincoin memecoin.

1) Wallet use:
Connection to the wallet (entered manually) is used only to verify ownership of the Pincoin token in the indicated wallet (read-only). Seed phrases or private keys are never requested or stored. The full wallet address will be stored only if a user wins, to enable manual prize delivery.

2) Data storage:
Failed attempts and private messages are not stored. Global chat stores up to the last 20 messages. Only winner information (full wallet, winning pin, timestamp) is saved to allow manual payout.

3) Prizes and pool:
Initial prize pool is 10,000,000 PIN. Max prize per event is 25% of the pool. Exact amount is decided by the community/admin and announced publicly on official channels.

4) Probabilities:
Win probability is adjusted periodically according to Pincoin market price. As price increases, chance increases up to 20% at $1 USD.

5) Acceptance:
By accepting, the user declares they have read and understood, and grants permission for the checks described (token verification, winner record). Participation is voluntary and not financial advice.

6) Liability:
Pincoin is not responsible for losses or misunderstandings. Participate responsibly.

Follow official channels for news and changes.`,
    acceptBtn: 'Accept',
    verifyBtn: 'Verify ownership',
    walletMissing: 'Enter a valid wallet.',
    needToken: 'You need at least 1 PIN to participate.'
  }
};

/* =========================
   UTIL HELPERS
   ========================= */
function t(k){ return TEXTS[lang][k] || k; }
function truncate(addr){ if(!addr) return ''; return addr.slice(0,4)+'…'+addr.slice(-4); }
function fmt(n){ return Number(n).toLocaleString(); }

/* =========================
   FLOW: LANGUAGE -> PRIVACY -> APP
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  const languageModal = document.getElementById('languageModal');
  const privacyModal = document.getElementById('privacyModal');
  const mainApp = document.getElementById('app');
  const acceptBtn = document.getElementById('acceptPolicyBtn');
  const privacyText = document.getElementById('privacyText');

  // initial states
  languageModal.style.display='flex';
  privacyModal.style.display='none';
  mainApp.style.display='block'; // app visible but modals block interaction

  // set privacy text initially in 'es' default
  privacyText.textContent = TEXTS['es'].policy;
  document.getElementById('policyTitle').textContent = TEXTS['es'].policyTitle;
  acceptBtn.textContent = TEXTS['es'].acceptBtn;

  // language buttons
  const langBtns = languageModal.querySelectorAll('button[data-lang]');
  langBtns.forEach(b => b.addEventListener('click', ()=>{
    lang = b.dataset.lang === 'en' ? 'en' : 'es';
    // apply i18n text in modals and small ui
    document.getElementById('policyTitle').textContent = TEXTS[lang].policyTitle;
    privacyText.textContent = TEXTS[lang].policy;
    acceptBtn.textContent = TEXTS[lang].acceptBtn;
    document.getElementById('verifyBtn').textContent = TEXTS[lang].verifyBtn;
    document.getElementById('aboutText').textContent = (lang==='es' ? 'Pincoin es una memecoin con utilidad. Verifica tu wallet para participar en sorteos.' : 'Pincoin is a memecoin with utility. Verify your wallet to join giveaways.');
    // show privacy modal
    languageModal.style.display='none';
    privacyModal.style.display='flex';
    // require scroll + timer to enable accept
    acceptBtn.disabled = true;
    let scrolled = false;
    privacyText.scrollTop = 0;
    privacyText.addEventListener('scroll', function onscroll(){ if(!scrolled && privacyText.scrollTop + privacyText.clientHeight >= privacyText.scrollHeight - 2){ scrolled = true; privacyText.removeEventListener('scroll', onscroll); if(timerOk) acceptBtn.disabled = false; } });
    let timerOk = false;
    setTimeout(()=>{ timerOk = true; if(scrolled) acceptBtn.disabled = false; }, 3000);
  }));

  // accept button
  acceptBtn.addEventListener('click', ()=>{
    privacyModal.style.display='none';
    // mainApp stays visible; user can interact
    // initial load
    fetchPriceAndSetProb();
    loadGlobalChat(); // load chat once
    setInterval(loadGlobalChat, 5000);
  });
});

/* =========================
   PRICE FETCH & PROB
   ========================= */
async function fetchPriceAndSetProb(){
  const badge = document.getElementById('probBadge');
  try{
    const resp = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${TOKEN_MINT}`);
    if(!resp.ok) throw new Error('no price');
    const j = await resp.json();
    let price = 0;
    if(j && j.pairs && j.pairs.length && j.pairs[0].priceUsd) price = Number(j.pairs[0].priceUsd);
    currentPrice = price || 0;
  }catch(e){
    console.warn('price fetch failed', e);
    currentPrice = 0;
  }
  currentProb = Math.min(P_MAX, P_MAX * (currentPrice / 1.0));
  const priceText = currentPrice ? `$${currentPrice.toFixed(6)}` : 'N/A';
  const probPct = (currentProb*100).toFixed(5);
  badge.textContent = (lang==='es' ? `Precio actual: ${priceText} | Probabilidad: ${probPct}%` : `Current price: ${priceText} | Win chance: ${probPct}%`);
}

/* =========================
   VERIFY WALLET (RPC)
   ========================= */
function openVerify(){ document.getElementById('verifyModal').style.display='flex'; document.getElementById('verifyResult').innerText=''; document.getElementById('verifyWalletInput').value = ''; }

async function doVerifyWallet(){
  const inp = document.getElementById('verifyWalletInput').value.trim();
  const resultEl = document.getElementById('verifyResult');
  if(!inp){ resultEl.textContent = TEXTS[lang].walletMissing; return; }
  resultEl.textContent = 'Comprobando...';
  try{
    // Call Solana RPC to list token accounts by owner
    const body = { jsonrpc:"2.0", id:1, method:"getTokenAccountsByOwner", params:[inp,{mint:TOKEN_MINT},{encoding:"jsonParsed"}] };
    const r = await fetch(SOLANA_RPC, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await r.json();
    let has = false;
    if(j && j.result && Array.isArray(j.result.value)){
      for(const acc of j.result.value){
        const t = acc.account.data.parsed.info.tokenAmount;
        const ui = t.uiAmount || (Number(t.amount) / Math.pow(10, t.decimals || 0));
        if(Number(ui) >= 1) { has = true; break; }
      }
    }
    if(has){
      verifiedWallet = inp;
      document.getElementById('walletInfo').textContent = (lang==='es' ? 'Wallet: ' : 'Wallet: ') + truncate(verifiedWallet);
      resultEl.textContent = (lang==='es' ? 'Titularidad verificada. Ya puedes participar.' : 'Ownership verified. You can participate.');
    } else {
      resultEl.textContent = (lang==='es' ? 'No se detecta PIN en esa wallet.' : 'No PIN detected in that wallet.');
    }
  }catch(err){
    console.error('verify rpc error', err);
    resultEl.textContent = (lang==='es' ? 'Error comprobando. Ver consola.' : 'Error checking. See console.');
  }
}

/* =========================
   ATTEMPTS / BOT / SAVE WINNER
   ========================= */
function appendAttempt(userLabel, text, success=false){
  const chat = document.getElementById('attemptsChat');
  const node = document.createElement('div');
  node.className = 'msg';
  node.innerHTML = `<div class="meta">${userLabel} · ${new Date().toLocaleTimeString()}</div><div>${text}${success? ' → ✅' : ''}</div>`;
  chat.prepend(node);
  while(chat.children.length > 200) chat.removeChild(chat.lastChild);
}

let botInterval = null;
function startBots(){
  if(botInterval) clearInterval(botInterval);
  botInterval = setInterval(()=>{
    const fake = String(Math.floor(Math.random()*1000000)).padStart(6,'0');
    appendAttempt('Anonimus', `Intento: ${fake}`, false);
    attemptsLocal++;
    updateAttemptCounter();
  }, 9000);
}
startBots();

function updateAttemptCounter(){ document.getElementById('attemptsCounter').textContent = (lang==='es' ? 'Intentos totales: ' : 'Total attempts: ') + fmt(attemptsLocal); }

async function tryPin(){
  if(!verifiedWallet && !document.getElementById('anonCheckbox').checked){
    alert(lang==='es' ? 'Verifica tu wallet o marca anónimo.' : 'Verify your wallet or choose anonymous.');
    return;
  }
  const pin = document.getElementById('pinInput').value.trim();
  if(!pin){ alert(lang==='es' ? 'Introduce un PIN.' : 'Enter a PIN.'); return; }
  const userLabel = document.getElementById('anonCheckbox').checked ? 'Anónimo' : truncate(verifiedWallet || 'guest');
  // compute
  const chance = currentProb || 0.00000000001;
  const roll = Math.random();
  const success = roll < chance;
  appendAttempt(userLabel, `Intento: ${pin}`, success);
  attemptsLocal++;
  updateAttemptCounter();
  // try to store attempts best-effort (optional)
  try { await supabase.from('attempts').insert([{ wallet: userLabel, pin, success }]); } catch(e){ /* ignore */ }
  if(success){
    // save winner (wallet complete)
    const walletToSave = document.getElementById('anonCheckbox').checked ? null : verifiedWallet;
    try{
      await supabase.from('winners').insert([{ wallet: walletToSave, pin }]);
      document.getElementById('winnerText').innerHTML = (lang==='es' ? `¡GANADOR! Wallet: ${walletToSave || 'Anónimo'}<br>PIN: ${pin}` : `WINNER! Wallet: ${walletToSave || 'Anonymous'}<br>PIN: ${pin}`);
      document.getElementById('winnerModal').style.display = 'flex';
    }catch(err){
      console.error('save winner error',err);
      alert((lang==='es' ? 'Ganador pero no se pudo guardar en DB (ver consola).' : 'Winner but could not save to DB (check console).'));
    }
  }
}

/* =========================
   GLOBAL CHAT (Supabase)
   ========================= */
const bannedWords = ['puta','mierda','idiota','stupid','idiot']; // ejemplo

async function loadGlobalChat(){
  try{
    const { data, error } = await supabase.from('global_chat').select('username,message,created_at').order('created_at',{ascending:false}).limit(20);
    if(error) throw error;
    const chat = document.getElementById('globalChat');
    chat.innerHTML = '';
    (data||[]).reverse().forEach(m=>{
      const el = document.createElement('div');
      el.innerHTML = `<span class="kv">Pincoin:${escapeHtml(m.username)}:</span> ${escapeHtml(m.message)}`;
      chat.appendChild(el);
    });
  }catch(err){
    console.warn('load chat error',err);
  }
}
async function sendGlobal(){
  const raw = document.getElementById('globalInput').value.trim();
  if(!raw) return;
  // extract nickname if user uses "Nick: message"
  let nickname = 'User';
  let message = raw;
  if(raw.includes(':')){
    const parts = raw.split(':');
    nickname = parts.shift().trim();
    message = parts.join(':').trim();
  } else {
    nickname = prompt(lang==='es' ? 'Elige un nickname' : 'Choose a nickname','User') || 'User';
  }
  // basic filter
  const low = message.toLowerCase();
  if(bannedWords.some(w=>low.includes(w))){
    alert(lang==='es' ? 'Mensaje no permitido.' : 'Message not allowed.');
    return;
  }
  try{
    await supabase.from('global_chat').insert([{ username: nickname, message }]);
    document.getElementById('globalInput').value='';
    loadGlobalChat();
  }catch(err){
    console.error('send global error',err);
    alert(lang==='es' ? 'Error enviando mensaje (ver consola).' : 'Error sending message (check console).');
  }
}

/* =========================
   HELPERS + INIT
   ========================= */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

function closeWinner(){ document.getElementById('winnerModal').style.display='none'; }

setInterval(fetchPriceAndSetProb, 60_000);
setInterval(loadGlobalChat, 5000);

</script>
</body>
</html>